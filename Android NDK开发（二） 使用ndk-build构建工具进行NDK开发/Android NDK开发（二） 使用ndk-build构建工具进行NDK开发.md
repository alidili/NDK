# <center><big>Android NDK开发（二） 使用ndk-build构建工具进行NDK开发</big></center>

> 作者：杨乐
>
> 日期：2021/12/28
>
> 版本：1.0

[TOC]

> 本文主要讲解了在Windows环境下如何使用ndk-build构建工具来进行NDK开发，以及ndk-build构建工具在Android Stuido中的快捷工具配置。

在上一篇文章 《Android NDK开发（一） 使用CMake构建工具进行NDK开发》 中，我们学习了如何使用CMake构建工具来进行NDK开发，但是一些老项目还是使用的ndk-build构建工具进行开发的，今天我们就来学习一下如何使用ndk-build构建工具。

# 0.环境搭建

在SDK Tools中安装NDK开发环境（File > Settings > Appearance & Behavior > System Settings > Android SDK > SDK Tools）：

![安装NDK开发环境](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E5%AE%89%E8%A3%85NDK%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.png)

新建一个普通的Android项目，在main目录下新建jni目录，在此目录下编写原生代码：

![新建jni目录](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E6%96%B0%E5%BB%BAjni%E7%9B%AE%E5%BD%95.png)

在main目录下新建jniLibs目录，此目录为Android Stuido加载so文件的默认目录，看下项目结构：

![项目结构](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png)

# 1.快捷键配置

打开File > Settings > Tools > External Tools选项，点击【+】按钮添加生成jni头文件以及ndk-build命令的快捷工具：

**生成头文件**

![生成头文件快捷设置](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E7%94%9F%E6%88%90%E5%A4%B4%E6%96%87%E4%BB%B6%E5%BF%AB%E6%8D%B7%E8%AE%BE%E7%BD%AE.png)

- Name：javah-jni

  工具名称

- Program：\$JDKPath\$/bin/javah

  javah所在的路径，\$JDKPath\$代表在环境变量中配置的JDK路径。

- Parameters：-jni  -encoding UTF-8 -d  \$ModuleFileDir\$\src\main\jni \$FileClass\$ 

  命令参数：

  - -jni代表生成JNI样式的标头文件，文件名为当前包名+类名（\$FileClass\$）
  
  - -encoding代表编码格式为UTF-8
  
  - -d代表指定头文件的输出路径为jni目录（\$ModuleFileDir\$\src\main\jni ）

- Working directory：\$ModuleFileDir\$\src\main\java

  工作目录，\$ModuleFileDir\$为当前module的路径。

```
javah用法: 
  javah [options] <classes>
其中, [options] 包括:
  -o <file>                输出文件 (只能使用 -d 或 -o 之一)
  -d <dir>                 输出目录
  -v  -verbose             启用详细输出
  -h  --help  -?           输出此消息
  -version                 输出版本信息
  -jni                     生成 JNI 样式的标头文件 (默认值)
  -force                   始终写入输出文件
  -classpath <path>        从中加载类的路径
  -cp <path>               从中加载类的路径
  -bootclasspath <path>    从中加载引导类的路径
<classes> 是使用其全限定名称指定的
(例如, java.lang.Object)。
```

**NDK构建**

![NDK构建](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/NDK%E6%9E%84%E5%BB%BA.png)

ndk-build的配置和javah-jni类似，其中C:\Tools\NDK\android-ndk-r14b\ndk-build.cmd为ndk-build构建工具的路径，需要按照实际NDK安装路径进行修改。

**如何调用**

右击项目选择External Tools：

![使用快捷工具](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E4%BD%BF%E7%94%A8%E5%BF%AB%E6%8D%B7%E5%B7%A5%E5%85%B7.png)

# 2.NDK开发

准备工作都做完了，下面进入正题，看下MainActivity：

```
public class MainActivity extends AppCompatActivity {

    // 加载native-lib，不加lib前缀
    static {
        System.loadLibrary("native-lib");
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // 将获取的字符串显示在TextView上
        TextView tv = findViewById(R.id.sample_text);
        tv.setText(stringFromJNI());
    }

    /**
     * native-lib中的原生方法
     */
    public native String stringFromJNI();
}
```
首先加载native-lib库，然后调用其中的stringFromJNI方法，将其返回的字符串显示在TextView上，此时还没有native-lib库，别急，继续往下看：

对着MainActivity的类名右击鼠标，选择External Tools > javah-jni，控制台执行完命令后，会在jni目录生成一个头文件：

![生成头文件](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E7%94%9F%E6%88%90%E5%A4%B4%E6%96%87%E4%BB%B6.png)

看下生成的头文件：

```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_yl_ndkdemo_MainActivity */

#ifndef _Included_com_yl_ndkdemo_MainActivity
#define _Included_com_yl_ndkdemo_MainActivity

#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_yl_ndkdemo_MainActivity
 * Method:    stringFromJNI
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_yl_ndkdemo_MainActivity_stringFromJNI
        (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

可以看到第一行注释写到：这是自动生成的，不要去修改它。好，不改就不改，Go on：

在jni目录中新建cpp类native-lib.cpp：

```
#include "com_yl_ndkdemo_MainActivity.h"

JNIEXPORT jstring JNICALL Java_com_yl_ndkdemo_MainActivity_stringFromJNI
        (JNIEnv *env, jobject) {
    return env->NewStringUTF("Hello from C++");
}
```

引用上文中生成的头文件，返回一个字符串给Java层，方法名是通过 **Java_包名_类名_方法名** 的方式命名的。

接着在jni目录下创建Android.mk和Application.mk配置文件，分别来看看：

**Android.mk**

```
# 当前路径
LOCAL_PATH := $(call my-dir)

# 清除LOCAL_XXX变量
include $(CLEAR_VARS)

# 原生库名称
LOCAL_MODULE := native-lib

# 原生代码文件
LOCAL_SRC_FILES =: native-lib.cpp

# 编译动态库
include $(BUILD_SHARED_LIBRARY)
```

在app的build.gradle文件中关联Android.mk：

```
android {
    ...
  
    externalNativeBuild {
        ndkBuild {
            path 'src/main/jni/Android.mk'
        }
    }
}
```

相当于执行了【Link C++ Project with Gradle】：

![在Gradle配置中关联C++项目](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E5%9C%A8Gradle%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%85%B3%E8%81%94C%2B%2B%E9%A1%B9%E7%9B%AE.png)

**Application.mk**

```
# 原生库名称
APP_MODULES := native-lib

# 指定机器指令集
APP_ABI := armeabi armeabi-v7a arm64-v8a x86 x86_64 mips mips64
```

到这里基本的开发流程就已经完成了，运行程序看下效果：

![运行效果](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C.png)

分析一下APK文件，可以看到so文件已经打包进去了：

![分析APK文件](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E5%88%86%E6%9E%90APK%E6%96%87%E4%BB%B6.png)

# 3.编译so文件

对着jni目录右击鼠标，选择External Tools > ndk-build，会在main目录下生成libs和obj目录，编译出的so文件就在libs目录下：

![编译so文件](https://github.com/alidili/NDK/raw/main/Android%20NDK%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89%20%E4%BD%BF%E7%94%A8ndk-build%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8CNDK%E5%BC%80%E5%8F%91/resources/%E7%BC%96%E8%AF%91so%E6%96%87%E4%BB%B6.png)

将so文件拷贝到jniLibs目录下就可以正常使用了，也可以在app的build.gradle文件中设置so文件的路径。

**注意：编译出的so文件就相当于java中的jar包，上文中的jni就相当于library，两者不要重复使用。**

# 4.遇到的问题

在ndk-build的过程中遇到了下面这行警告，但是没有影响编译so文件，没有找到好的解决方法，有知道的同学可以留言告诉我，多谢！

```
Android NDK: WARNING: Unsupported source file extensions in jni/Android.mk for module native-lib
```

# 5.写在最后

源码已经上传到GitHub上了，欢迎Fork，觉得还不错就Start一下吧！

GitHub传送门：https://github.com/alidili/Demos/tree/master/NDKDemo